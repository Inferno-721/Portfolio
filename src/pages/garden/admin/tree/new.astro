---
export const prerender = false;
import BaseLayout from "@/layouts/BaseLayout.astro";
import BackLink from "@/components/garden/BackLink.astro";
import { createClient } from '@supabase/supabase-js';
import { isUserAdmin } from '@/lib/auth';

// Check if user is admin
const { userId } = Astro.locals.auth();
const isAdmin = await isUserAdmin(userId);

if (!isAdmin) {
  return Astro.redirect('/garden');
}

// Handle form submission
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const name = formData.get('name')?.toString();
    const slug = formData.get('slug')?.toString();
    const description = formData.get('description')?.toString();
    
    // Validate inputs
    if (!name || !slug || !description) {
      throw new Error('All fields are required');
    }
    
    // Create Supabase client
    const supabaseUrl = import.meta.env.SUPABASE_URL;
    const supabaseAnonKey = import.meta.env.SUPABASE_KEY;
    const supabase = createClient(supabaseUrl, supabaseAnonKey);
    
    // Insert new tree
    const { error } = await supabase
      .from('trees')
      .insert([{ name, slug, description }]);
      
    if (error) throw error;
    
    // Redirect to the new tree page
    return Astro.redirect(`/garden/${slug}`);
  } catch (error) {
    console.error('Error creating tree:', error);
  }
}
---

<BaseLayout title="Add New Tree" description="Create a new tree in your digital garden">
  <div class="container mx-auto pt-24 pb-12 md:pt-32 xl:pt-24">
    <BackLink href="/garden/" text="Back to Garden" />
    
    <div class="mx-auto max-w-2xl">
      <h1 class="mb-8 text-3xl font-bold">Add New Tree</h1>
      
      <form method="POST" class="space-y-6">
        <div>
          <label for="name" class="block text-sm font-medium">Name</label>
          <input 
            type="text" 
            id="name" 
            name="name" 
            required
            class="mt-1 block w-full rounded-md border border-black/20 bg-white/90 p-2 shadow-sm dark:border-white/20 dark:bg-black/60"
          />
        </div>
        
        <div>
          <label for="slug" class="block text-sm font-medium">Slug</label>
          <input 
            type="text" 
            id="slug" 
            name="slug" 
            required
            pattern="[a-z0-9-]+"
            class="mt-1 block w-full rounded-md border border-black/20 bg-white/90 p-2 shadow-sm dark:border-white/20 dark:bg-black/60"
          />
          <p class="mt-1 text-xs text-black/60 dark:text-white/60">
            Only lowercase letters, numbers, and hyphens
          </p>
        </div>
        
        <div>
          <label for="description" class="block text-sm font-medium">Description</label>
          <textarea 
            id="description" 
            name="description" 
            rows="4" 
            required
            class="mt-1 block w-full rounded-md border border-black/20 bg-white/90 p-2 shadow-sm dark:border-white/20 dark:bg-black/60"
          ></textarea>
        </div>
        
        <div>
          <button 
            type="submit"
            class="rounded-md bg-black px-4 py-2 text-white hover:bg-black/80 dark:bg-white dark:text-black dark:hover:bg-white/80"
          >
            Create Tree
          </button>
        </div>
      </form>
    </div>
  </div>
</BaseLayout>